<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Face Recognition Portal</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 2rem; background: #fafafa; }
    h2 { color: #333; }
    button { padding: 12px 24px; font-size: 1rem; margin: 20px; }
    img { margin-top: 20px; width: 400px; border: 4px solid #333; }
    #status { font-size: 1.2rem; margin-top: 20px; }
    table { margin: 20px auto; border-collapse: collapse; width: 80%; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 10px; text-align: center; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>Real-Time Face Recognition</h2>
  <button onclick="detectFace()">Detect Face</button>
  <button onclick="registerFace()">Register Face</button> 
  <button onclick="clearData()" style="background-color: #ff4444; color: white;">Clear All Data</button>
  <button onclick="openGate()" style="background-color: #4CAF50; color: white;">Open Gate</button>
  <button id="logoutButton" style="background-color: #ff4444; color: white; padding: 10px 20px; font-size: 1rem;">Logout</button>
  <div id="status"></div>
  <div id="result"></div>
  <div id="userHistory">
    <h3>Visit History</h3>
    <button id="toggleHistoryBtn" onclick="toggleHistory()">View History</button>

<table id="historyTable" class="hidden">
  <thead>
    <tr>
      <th>Name</th>
      <th>Total Visits</th>
      <th>Visit Timestamps</th>
      <th>View Images</th>
    </tr>
  </thead>
  <tbody id="historyContent"></tbody>
</table>
  </div>

  <script>


    async function detectFace() {
      document.getElementById("status").innerText = "Detecting face, please wait...";
      document.getElementById("result").innerHTML = "";

      try {
        const response = await fetch("/api/predict_face", {
          method: "POST",
        });

        const data = await response.json();

        if (data.status === "success") {
          const msg = `Detected: ${data.name} (${data.label})`;
          const imageURL = data.image_path;

          document.getElementById("status").innerText = msg;
          document.getElementById("result").innerHTML = `<img src="${imageURL}" alt="Face Image">`;

          if (data.name !== "Unknown") {
            await showUserHistory(data.name);
          }
        } else {
          document.getElementById("status").innerText = data.message;
        }
      } catch (error) {
        document.getElementById("status").innerText = "Error detecting face. Please try again.";
        console.error("Error:", error);
      }
    }

    async function registerFace() {
    const name = prompt("Enter the name to register:");
    if (!name) {
      document.getElementById("status").innerText = "Registration cancelled.";
      return;
    }

    document.getElementById("status").innerText = `Registering face for ${name}...`;
    document.getElementById("result").innerHTML = "";

    try {
      const response = await fetch(`/api/register_face?name=${encodeURIComponent(name)}`);
      const data = await response.json();

      if (data.status === "success") {
        document.getElementById("status").innerText = data.message;
      } else {
        document.getElementById("status").innerText = `Error: ${data.message}`;
      }
    } catch (error) {
      document.getElementById("status").innerText = `Error registering face: ${error}`;
      console.error("Error:", error);
    }
  }


    async function clearData() {
      if (confirm("Are you sure? This will delete all registered faces and stored images.")) {
        try {
          document.getElementById("status").innerText = "Clearing data...";
          const response = await fetch("/api/clear_data", {
            method: "POST",
          });
          const data = await response.json();
          document.getElementById("status").innerText = data.message;
          document.getElementById("result").innerHTML = "";
        } catch (error) {
          document.getElementById("status").innerText = "Error clearing data: " + error;
        }
      }
    }

    async function showUserHistory(name) {
      try {
        const response = await fetch(`/api/user_history/${name}`, {
        });
        const data = await response.json();
        
        if (data.status === 'success') {
          const history = data.data;
          const tbody = document.getElementById('historyContent');
tbody.innerHTML = '';

const row = document.createElement('tr');

// Name
const nameCell = document.createElement('td');
nameCell.textContent = history.name;
row.appendChild(nameCell);

// Total Visits
const visitCountCell = document.createElement('td');
visitCountCell.textContent = history.visit_count;
row.appendChild(visitCountCell);

// Visit Timestamps (View button)
const timestampCell = document.createElement('td');
const toggleTimestampsBtn = document.createElement('button');
toggleTimestampsBtn.textContent = "View";
const timestampList = document.createElement('ul');
timestampList.style.display = 'none';

history.timestamps.forEach(ts => {
  const li = document.createElement('li');
  li.textContent = new Date(ts).toLocaleString();
  timestampList.appendChild(li);
});

toggleTimestampsBtn.onclick = () => {
  timestampList.style.display = timestampList.style.display === 'none' ? 'block' : 'none';
};

timestampCell.appendChild(toggleTimestampsBtn);
timestampCell.appendChild(timestampList);
row.appendChild(timestampCell);

// View Images (optional)
const imageCell = document.createElement('td');
const viewImgBtn = document.createElement('button');
viewImgBtn.textContent = "View";
const imgDiv = document.createElement('div');
imgDiv.style.display = 'none';

if (history.images) {
  history.images.forEach(img => {
    const image = document.createElement('img');
    image.src = `data:image/jpeg;base64,${img.image_data}`;
    image.style.width = '100px';
    image.style.margin = '5px';
    imgDiv.appendChild(image);
  });
}

viewImgBtn.onclick = () => {
  imgDiv.style.display = imgDiv.style.display === 'none' ? 'block' : 'none';
};

imageCell.appendChild(viewImgBtn);
imageCell.appendChild(imgDiv);
row.appendChild(imageCell);

tbody.appendChild(row);

        }
      } catch (error) {
        console.error('Error fetching user history:', error);
      }
    }

    async function fetchAndRenderHistory() {
  const response = await fetch('/api/all_user_history');
  const result = await response.json();

  if (result.status === 'success') {
    const tbody = document.getElementById('historyContent');
    tbody.innerHTML = '';

    result.data.forEach(user => {
      const row = document.createElement('tr');

      // Name
      const nameCell = document.createElement('td');
      nameCell.textContent = user.name;
      row.appendChild(nameCell);

      // Total Visits
      const visitCountCell = document.createElement('td');
      visitCountCell.textContent = user.visit_count;
      row.appendChild(visitCountCell);

      // Visit Timestamps with toggle
      const timestampCell = document.createElement('td');
      const toggleTimestampsBtn = document.createElement('button');
      toggleTimestampsBtn.textContent = "View";
      const timestampList = document.createElement('ul');
      timestampList.style.display = 'none';

      user.timestamps.forEach(ts => {
        const li = document.createElement('li');
        li.textContent = ts;
        timestampList.appendChild(li);
      });

      toggleTimestampsBtn.onclick = () => {
        timestampList.style.display = timestampList.style.display === 'none' ? 'block' : 'none';
      };

      timestampCell.appendChild(toggleTimestampsBtn);
      timestampCell.appendChild(timestampList);
      row.appendChild(timestampCell);

      // View Images (Optional - you can keep this or skip)
      const imageCell = document.createElement('td');
      const viewImgBtn = document.createElement('button');
      viewImgBtn.textContent = "View";
      const imgDiv = document.createElement('div');
      imgDiv.style.display = 'none';
      user.images.forEach(img => {
        const image = document.createElement('img');
        image.src = `data:image/jpeg;base64,${img.image_data}`;
        image.style.width = '100px';
        image.style.margin = '5px';
        imgDiv.appendChild(image);
      });

      viewImgBtn.onclick = () => {
        imgDiv.style.display = imgDiv.style.display === 'none' ? 'block' : 'none';
      };

      imageCell.appendChild(viewImgBtn);
      imageCell.appendChild(imgDiv);
      row.appendChild(imageCell);

      tbody.appendChild(row);
    });
  }
}
function toggleHistory() {
  const table = document.getElementById("historyTable");
  const btn = document.getElementById("toggleHistoryBtn");

  if (table.classList.contains("hidden")) {
    table.classList.remove("hidden");
    btn.textContent = "Hide History";
    fetchAndRenderHistory();  // fetch only when visible
  } else {
    table.classList.add("hidden");
    btn.textContent = "View History";
  }
}

    async function openGate() {
      try {
        document.getElementById("status").innerText = "Opening gate...";
        const response = await fetch("/api/open_gate", {
          method: "POST",
        });
        const data = await response.json();

        if (data.status === 'success') {
          document.getElementById("status").innerText = "Gate opened successfully!";
        } else {
          document.getElementById("status").innerText = "Failed to open gate: " + data.message;
        }
      } catch (error) {
        document.getElementById("status").innerText = "Error opening gate: " + error;
      }
    }

    document.getElementById("logoutButton").addEventListener("click", () => {
      alert("You have been logged out.");
      window.location.href = "/login"; // Redirect to the login page
    });
  </script>
</body>
</html>